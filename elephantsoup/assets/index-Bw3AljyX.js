var y=Object.defineProperty;var S=(m,e,t)=>e in m?y(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var a=(m,e,t)=>S(m,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class E{constructor(){a(this,"data");a(this,"sessions",{});a(this,"STORAGE_KEY","elephant_soup_repertoire");a(this,"STORAGE_KEY_SESSIONS","elephant_soup_sessions");this.data=this.loadFromStorage(),this.migrateData(),this.sessions=this.loadSessionsFromStorage()}migrateData(){let e=!1;this.data.repertoire.forEach(t=>{this.getActiveSegments(t).length===1&&!t.nextDate&&(t.nextDate=new Date().toISOString(),e=!0)}),e&&this.saveToStorage()}loadSessionsFromStorage(){const e=localStorage.getItem(this.STORAGE_KEY_SESSIONS);if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse session data",t)}return{}}saveSessionsToStorage(){localStorage.setItem(this.STORAGE_KEY_SESSIONS,JSON.stringify(this.sessions))}saveSession(e,t){this.sessions[e]=t,this.saveSessionsToStorage()}getSession(e){return this.sessions[e]||null}clearSession(e){this.sessions[e]&&(delete this.sessions[e],this.saveSessionsToStorage())}loadFromStorage(){const e=localStorage.getItem(this.STORAGE_KEY);if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse repertoire data",t)}return{repertoire:[]}}saveToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.data))}exportData(){return JSON.stringify(this.data,null,2)}importData(e){try{const t=JSON.parse(e);if(t&&Array.isArray(t.repertoire))return this.data=t,this.saveToStorage(),!0}catch(t){console.error("Import failed",t)}return!1}getPieces(){return this.data.repertoire}getPiece(e){return this.data.repertoire.find(t=>t.id===e)}addPiece(e,t){const s={id:crypto.randomUUID(),name:e,totalMeasures:t,segments:[]};for(let i=1;i<=t;i++)s.segments.push({id:crypto.randomUUID(),start:i,end:i,readiness:0,lastPracticed:null});return this.data.repertoire.push(s),this.saveToStorage(),s}deletePiece(e){this.data.repertoire=this.data.repertoire.filter(t=>t.id!==e),this.saveToStorage(),this.clearSession(e)}getActiveSegments(e){return e.segments.filter(t=>t.readiness!==3?!0:!e.segments.some(i=>i.id!==t.id&&i.start<=t.start&&i.end>=t.end&&i.end-i.start>t.end-t.start))}getPracticeQueue(e){const t=this.getPiece(e);if(!t)return[];this.processMerges(t);const s=this.getActiveSegments(t),i={0:[],1:[],2:[],3:[]};s.forEach(n=>{const o=Math.max(0,Math.min(3,n.readiness));i[o]||(i[o]=[]),i[o].push(n)});let r=[];for(let n=0;n<=3;n++)r=r.concat(this.shuffleArray(i[n]));return r}shuffleArray(e){const t=[...e];for(let s=t.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[t[s],t[i]]=[t[i],t[s]]}return t}updateSegmentReadiness(e,t,s){const i=this.getPiece(e);if(!i)return;const r=i.segments.find(o=>o.id===t);if(!r)return;const n=r.lastPracticed;if(r.readiness=s,r.lastPracticed=new Date().toISOString(),this.getActiveSegments(i).length===1){const o=new Date,c=24*60*60*1e3;let d,u=c;n&&(u=o.getTime()-new Date(n).getTime()),u<0&&(u=0);const l=u/c;if(s===0)d=o;else if(s===1)d=new Date(o.getTime()+c);else if(s===2){const g=Math.max(1,l);d=new Date(o.getTime()+g*c)}else if(s===3){const g=Math.max(2,2*l);d=new Date(o.getTime()+g*c)}else d=o;const h=new Date(o.getTime()+365*c);d>h&&(d=h),i.nextDate=d.toISOString()}this.saveToStorage()}processMerges(e){console.log("--- Process Merges: Current State ---");const t=r=>r.start===r.end?`[${r.start}]`:`[${r.start}-${r.end}]`;[...e.segments].sort((r,n)=>r.start-n.start||r.end-r.start-(n.end-n.start)).forEach(r=>{console.log(`${t(r)} ${r.readiness}`)}),console.log("-------------------------------------");const i=e.segments.filter(r=>r.readiness===3).sort((r,n)=>r.start-n.start);for(const r of i){const n=e.segments.filter(l=>l.end===r.start-1&&l.readiness===3),o=e.segments.filter(l=>l.start===r.end+1&&l.readiness===3),d=[...n,...o].filter(l=>{const h=Math.min(r.start,l.start),g=Math.max(r.end,l.end);return e.segments.some(p=>p.start===h&&p.end===g)?!1:!e.segments.some(p=>!(p.id===r.id||p.id===l.id||p.start>=h&&p.end<=g||p.start<=h&&p.end>=g||!(p.start<=g&&p.end>=h)))});let u=null;if(d.length>0&&(d.sort((l,h)=>{const g=l.end-l.start,f=h.end-h.start;return g!==f?g-f:l.start-h.start}),u=d[0]),u){const l=Math.min(r.start,u.start),h=Math.max(r.end,u.end);e.segments.push({id:crypto.randomUUID(),start:l,end:h,readiness:0,lastPracticed:null}),console.log(`Merged
[${l}-${h}] 0`),this.saveToStorage()}}}calculateReadiness(e){const t=this.getPiece(e);if(!t||t.totalMeasures===0)return 0;const s=t.totalMeasures,i=s*s;let r=0;for(let n=1;n<=s;n++){const o=t.segments.filter(c=>c.start<=n&&c.end>=n&&c.readiness===3);if(o.length>0){const c=Math.max(...o.map(d=>d.end-d.start+1));r+=c}else{const c=t.segments.find(d=>d.start===n&&d.end===n);c&&(c.readiness===1?r+=.25:c.readiness===2&&(r+=.5))}}return Math.round(r/i*100)}isMastered(e){const t=this.getPiece(e);return t?this.getActiveSegments(t).length===1:!1}}const R={audio:{sampleRate:{ideal:44100},channelCount:{ideal:2},echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1},video:!1};function P(){const m="audio/webm; codecs=opus",e="audio/mp4; codecs=mp4a.40.2";let s="";return MediaRecorder.isTypeSupported(m)?s=m:MediaRecorder.isTypeSupported(e)?s=e:(s="audio/webm",MediaRecorder.isTypeSupported(s)||(s="audio/mp4")),{mimeType:s,audioBitsPerSecond:256e3}}class B{constructor(){a(this,"mediaRecorder",null);a(this,"audioChunks",[]);a(this,"currentAudioBlob",null);a(this,"isRecording",!1);a(this,"hasRecording",!1);a(this,"isPlaying",!1);a(this,"audio",null);a(this,"currentAudioUrl",null);a(this,"onRecordingFinished",()=>{});a(this,"onPlaybackFinished",()=>{});a(this,"onError",()=>{})}async startRecording(){try{const e=await navigator.mediaDevices.getUserMedia(R),t=P();this.mediaRecorder=new MediaRecorder(e,t),this.audioChunks=[],this.mediaRecorder.ondataavailable=s=>{s.data.size>0&&this.audioChunks.push(s.data)},this.mediaRecorder.onstop=()=>{this.mediaRecorder&&(this.currentAudioBlob=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType}),this.hasRecording=!0,this.isRecording=!1,e.getTracks().forEach(s=>s.stop()),this.onRecordingFinished())},this.mediaRecorder.start(),this.isRecording=!0}catch(e){this.onError("Failed to start recording: "+e.message)}}stopRecording(){this.mediaRecorder&&this.isRecording&&this.mediaRecorder.stop()}playRecording(){this.currentAudioBlob&&this.hasRecording?(this.currentAudioUrl&&URL.revokeObjectURL(this.currentAudioUrl),this.currentAudioUrl=URL.createObjectURL(this.currentAudioBlob),this.audio=new Audio(this.currentAudioUrl),this.audio.volume=1,this.audio.onended=()=>{this.handlePlaybackEnd()},this.audio.play().catch(e=>this.onError("Playback failed: "+e.message)),this.isPlaying=!0):this.onError("No recording to play")}stopPlaying(){this.audio&&!this.audio.paused&&(this.audio.pause(),this.audio.currentTime=0,this.handlePlaybackEnd())}handlePlaybackEnd(){this.isPlaying=!1,this.currentAudioUrl&&(URL.revokeObjectURL(this.currentAudioUrl),this.currentAudioUrl=null),this.onPlaybackFinished()}}class b{constructor(){a(this,"manager");a(this,"recorder");a(this,"repertoireView");a(this,"practiceView");a(this,"pieceList");a(this,"newPieceForm");a(this,"readinessControls");a(this,"status");a(this,"error");a(this,"recordButton");a(this,"playButton");a(this,"currentPieceId",null);a(this,"practiceQueue",[]);a(this,"currentSegment",null);a(this,"resumeModal");a(this,"resumePieceName");a(this,"resumeBtn");a(this,"discardBtn");a(this,"cancelResumeBtn");this.manager=new E,this.recorder=new B,this.repertoireView=document.getElementById("repertoire-view"),this.practiceView=document.getElementById("practice-view"),this.pieceList=document.getElementById("piece-list"),this.newPieceForm=document.getElementById("new-piece-form"),this.readinessControls=document.getElementById("readiness-controls"),this.status=document.getElementById("status"),this.error=document.getElementById("error"),this.recordButton=document.getElementById("recordButton"),this.playButton=document.getElementById("playButton"),this.resumeModal=document.getElementById("resume-modal"),this.resumePieceName=document.getElementById("resume-piece-name"),this.resumeBtn=document.getElementById("resume-btn"),this.discardBtn=document.getElementById("discard-btn"),this.cancelResumeBtn=document.getElementById("cancel-resume-btn"),this.init()}init(){this.setupRepertoireUI(),this.setupPracticeUI(),this.setupRecorderCallbacks(),this.setupModalCallbacks(),this.renderRepertoire()}setupModalCallbacks(){this.resumeBtn.addEventListener("click",()=>{this.currentPieceId&&(this.resumeSession(this.currentPieceId),this.resumeModal.style.display="none")}),this.discardBtn.addEventListener("click",()=>{this.currentPieceId&&(this.discardAndStartSession(this.currentPieceId),this.resumeModal.style.display="none")}),this.cancelResumeBtn.addEventListener("click",()=>{this.currentPieceId=null,this.resumeModal.style.display="none"})}setupRepertoireUI(){var e,t,s,i,r,n;(e=document.getElementById("add-piece-btn"))==null||e.addEventListener("click",()=>{this.newPieceForm.style.display="block",document.getElementById("add-piece-btn").style.display="none"}),(t=document.getElementById("cancel-piece-btn"))==null||t.addEventListener("click",()=>{this.newPieceForm.style.display="none",document.getElementById("add-piece-btn").style.display="block",document.getElementById("new-piece-name").value="",document.getElementById("new-piece-measures").value=""}),(s=document.getElementById("save-piece-btn"))==null||s.addEventListener("click",()=>{const o=document.getElementById("new-piece-name"),c=document.getElementById("new-piece-measures");o.value&&c.value&&(this.manager.addPiece(o.value,parseInt(c.value)),this.renderRepertoire(),this.newPieceForm.style.display="none",document.getElementById("add-piece-btn").style.display="block",o.value="",c.value="")}),(i=document.getElementById("export-btn"))==null||i.addEventListener("click",()=>{const o=this.manager.exportData(),c=new Blob([o],{type:"application/json"}),d=URL.createObjectURL(c),u=document.createElement("a");u.href=d,u.download=`elephant_soup_backup_${new Date().toISOString().slice(0,10)}.json`,u.click(),URL.revokeObjectURL(d)}),(r=document.getElementById("import-btn"))==null||r.addEventListener("click",()=>{var o;(o=document.getElementById("import-file"))==null||o.click()}),(n=document.getElementById("import-file"))==null||n.addEventListener("change",o=>{var u;const c=(u=o.target.files)==null?void 0:u[0];if(!c)return;const d=new FileReader;d.onload=l=>{var h;(h=l.target)!=null&&h.result&&(this.manager.importData(l.target.result)?(this.renderRepertoire(),alert("Data imported successfully")):alert("Failed to import data"))},d.readAsText(c)})}setupPracticeUI(){var t;(t=document.getElementById("back-to-repertoire"))==null||t.addEventListener("click",()=>{this.suspendSession()}),this.recordButton.addEventListener("click",()=>this.toggleRecording()),this.playButton.addEventListener("click",()=>this.togglePlayback()),document.querySelectorAll(".rate-btn").forEach(s=>{s.addEventListener("click",i=>{const r=parseInt(i.target.getAttribute("data-level")||"0");this.handleReadiness(r)})}),document.addEventListener("keydown",s=>{this.practiceView.style.display!=="none"&&this.resumeModal.style.display!=="flex"&&(s.code==="Space"?(s.preventDefault(),this.playButton.disabled||this.playButton.click()):s.code==="Enter"&&(s.preventDefault(),!this.recordButton.disabled&&this.readinessControls.style.display==="none"&&this.recordButton.click()))})}setupRecorderCallbacks(){this.recorder.onRecordingFinished=()=>{this.updateRecorderUI(),this.readinessControls.style.display="none"},this.recorder.onPlaybackFinished=()=>{this.updateRecorderUI(),this.readinessControls.style.display="block",this.status.textContent="Rate this segment:"},this.recorder.onError=e=>{this.error.textContent=e,this.error.style.display="block",setTimeout(()=>{this.error.style.display="none"},3e3)}}getAllPiecesSorted(){const t=this.manager.getPieces().map(s=>({piece:s,score:this.manager.calculateReadiness(s.id),isMastered:this.manager.isMastered(s.id),nextDate:s.nextDate?new Date(s.nextDate):void 0}));return t.sort((s,i)=>{var r,n;if(s.isMastered!==i.isMastered)return s.isMastered?1:-1;if(s.isMastered){const o=((r=s.nextDate)==null?void 0:r.getTime())||Number.MAX_VALUE,c=((n=i.nextDate)==null?void 0:n.getTime())||Number.MAX_VALUE;return o-c}else return s.score-i.score}),t}renderRepertoire(){this.pieceList.innerHTML="";const e=this.getAllPiecesSorted();if(e.length===0){this.pieceList.innerHTML='<div style="color:#666; padding:20px;">No pieces yet. Add one to start!</div>';return}e.forEach(t=>{var d;const{piece:s,score:i}=t,r=document.createElement("div");r.className="piece-item";const n=!!this.manager.getSession(s.id),o=n?'<span style="color: #0a84ff; margin-right:8px; font-size:0.8em"><i class="fas fa-pause-circle"></i> Resumable</span>':"";let c="";if(s.nextDate){const u=new Date(s.nextDate);u>new Date&&(c=`<br><span style="color: #888; font-size: 0.8em"><i class="fas fa-clock"></i> Due: ${u.toLocaleDateString()}</span>`)}r.innerHTML=`
                <div class="piece-info">
                    <strong>${s.name}</strong><br>
                    <span style="font-size:0.9em; color:#aaa">${s.totalMeasures} measures</span>
					${n?"<br>"+o:""}
					${c}
                </div>
                <div style="font-weight:bold; color: ${this.getScoreColor(i)}; margin-right: 15px;">
                    ${i}%
                </div>
                <button class="delete-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
            `,(d=r.querySelector(".delete-btn"))==null||d.addEventListener("click",u=>{u.stopPropagation(),confirm(`Delete "${s.name}"?`)&&(this.manager.deletePiece(s.id),this.renderRepertoire())}),r.addEventListener("click",()=>{this.startSession(s.id)}),this.pieceList.appendChild(r)})}startSession(e){if(this.currentPieceId=e,this.manager.getSession(e)){const s=this.manager.getPiece(e);s&&(this.resumePieceName.textContent=s.name,this.resumeModal.style.display="flex")}else this.discardAndStartSession(e)}discardAndStartSession(e){this.manager.clearSession(e),this.practiceQueue=this.manager.getPracticeQueue(e),this.activateSessionView(e)}resumeSession(e){const t=this.manager.getSession(e);t?(this.practiceQueue=t,this.manager.clearSession(e),this.activateSessionView(e)):this.discardAndStartSession(e)}activateSessionView(e){const t=this.manager.getPiece(e);t&&(this.repertoireView.style.display="none",this.practiceView.style.display="block",document.getElementById("current-piece-name").textContent=t.name,this.loadNextSegment())}suspendSession(){this.currentPieceId&&this.practiceQueue.length>=0&&(this.currentSegment&&this.practiceQueue.unshift(this.currentSegment),this.practiceQueue.length>0?(this.manager.saveSession(this.currentPieceId,this.practiceQueue),this.recorder.stopPlaying(),this.recorder.stopRecording(),this.stopSession()):this.stopSession())}stopSession(){this.recorder.stopPlaying(),this.recorder.stopRecording(),this.repertoireView.style.display="block",this.practiceView.style.display="none",this.currentPieceId=null,this.currentSegment=null,this.renderRepertoire()}loadNextSegment(){if(this.practiceQueue.length===0){alert("Session complete! Great work."),this.stopSession();return}if(this.currentSegment=this.practiceQueue.shift()||null,this.currentSegment){const e=document.getElementById("current-segment-display");this.currentSegment.start===this.currentSegment.end?e.textContent=`Measure ${this.currentSegment.start}`:e.textContent=`Measures ${this.currentSegment.start} - ${this.currentSegment.end}`,this.readinessControls.style.display="none",this.recorder.hasRecording=!1,this.recorder.audioChunks=[],this.status.textContent="Ready to record",this.updateRecorderUI()}}async toggleRecording(){this.recorder.isRecording?this.recorder.stopRecording():(await this.recorder.startRecording(),this.status.textContent="Recording...",this.updateRecorderUI())}togglePlayback(){this.recorder.isPlaying?this.recorder.stopPlaying():(this.recorder.playRecording(),this.status.textContent="Playing...",this.updateRecorderUI())}handleReadiness(e){this.currentPieceId&&this.currentSegment&&(this.manager.updateSegmentReadiness(this.currentPieceId,this.currentSegment.id,e),this.loadNextSegment())}updateRecorderUI(){const{isRecording:e,isPlaying:t,hasRecording:s}=this.recorder;e?(this.recordButton.classList.add("recording"),this.recordButton.innerHTML='<i class="fas fa-stop"></i><span>Stop</span>',this.playButton.disabled=!0):(this.recordButton.classList.remove("recording"),this.recordButton.innerHTML='<i class="fas fa-microphone"></i><span>Record</span>',this.recordButton.disabled=t),t?this.playButton.innerHTML='<i class="fas fa-stop"></i><span>Stop</span>':(this.playButton.disabled=!s||e,this.playButton.innerHTML='<i class="fas fa-play"></i><span>Play</span>')}getScoreColor(e){return e<25?"#ff453a":e<50?"#ff9f0a":e<75?"#ffd60a":"#30d158"}}document.addEventListener("DOMContentLoaded",()=>{new b});
