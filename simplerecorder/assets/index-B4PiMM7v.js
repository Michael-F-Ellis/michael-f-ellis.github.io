var y=Object.defineProperty;var S=(h,e,t)=>e in h?y(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var a=(h,e,t)=>S(h,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();class R{constructor(){a(this,"data");a(this,"sessions",{});a(this,"STORAGE_KEY","simple_recorder_repertoire");a(this,"STORAGE_KEY_SESSIONS","simple_recorder_sessions");this.data=this.loadFromStorage(),this.sessions=this.loadSessionsFromStorage()}loadSessionsFromStorage(){const e=localStorage.getItem(this.STORAGE_KEY_SESSIONS);if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse session data",t)}return{}}saveSessionsToStorage(){localStorage.setItem(this.STORAGE_KEY_SESSIONS,JSON.stringify(this.sessions))}saveSession(e,t){this.sessions[e]=t,this.saveSessionsToStorage()}getSession(e){return this.sessions[e]||null}clearSession(e){this.sessions[e]&&(delete this.sessions[e],this.saveSessionsToStorage())}loadFromStorage(){const e=localStorage.getItem(this.STORAGE_KEY);if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse repertoire data",t)}return{repertoire:[]}}saveToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.data))}exportData(){return JSON.stringify(this.data,null,2)}importData(e){try{const t=JSON.parse(e);if(t&&Array.isArray(t.repertoire))return this.data=t,this.saveToStorage(),!0}catch(t){console.error("Import failed",t)}return!1}getPieces(){return this.data.repertoire}getPiece(e){return this.data.repertoire.find(t=>t.id===e)}addPiece(e,t){const r={id:crypto.randomUUID(),name:e,totalMeasures:t,segments:[]};for(let i=1;i<=t;i++)r.segments.push({id:crypto.randomUUID(),start:i,end:i,readiness:0,lastPracticed:null});return this.data.repertoire.push(r),this.saveToStorage(),r}deletePiece(e){this.data.repertoire=this.data.repertoire.filter(t=>t.id!==e),this.saveToStorage(),this.clearSession(e)}getPracticeQueue(e){const t=this.getPiece(e);if(!t)return[];this.processMerges(t);const r=t.segments.filter(n=>n.readiness!==3?!0:!t.segments.some(o=>o.id!==n.id&&o.start<=n.start&&o.end>=n.end&&o.end-o.start>n.end-n.start)),i={0:[],1:[],2:[],3:[]};r.forEach(n=>{const d=Math.max(0,Math.min(3,n.readiness));i[d]||(i[d]=[]),i[d].push(n)});let s=[];for(let n=0;n<=3;n++)s=s.concat(this.shuffleArray(i[n]));return s}shuffleArray(e){const t=[...e];for(let r=t.length-1;r>0;r--){const i=Math.floor(Math.random()*(r+1));[t[r],t[i]]=[t[i],t[r]]}return t}updateSegmentReadiness(e,t,r){const i=this.getPiece(e);if(!i)return;const s=i.segments.find(n=>n.id===t);s&&(s.readiness=r,s.lastPracticed=new Date().toISOString(),this.saveToStorage())}processMerges(e){console.log("--- Process Merges: Current State ---");const t=s=>s.start===s.end?`[${s.start}]`:`[${s.start}-${s.end}]`;[...e.segments].sort((s,n)=>s.start-n.start||s.end-s.start-(n.end-n.start)).forEach(s=>{console.log(`${t(s)} ${s.readiness}`)}),console.log("-------------------------------------");const i=e.segments.filter(s=>s.readiness===3).sort((s,n)=>s.start-n.start);for(const s of i){const n=e.segments.filter(c=>c.end===s.start-1&&c.readiness===3),d=e.segments.filter(c=>c.start===s.end+1&&c.readiness===3),l=[...n,...d].filter(c=>{const u=Math.min(s.start,c.start),g=Math.max(s.end,c.end);return e.segments.some(p=>p.start===u&&p.end===g)?!1:!e.segments.some(p=>!(p.id===s.id||p.id===c.id||p.start>=u&&p.end<=g||p.start<=u&&p.end>=g||!(p.start<=g&&p.end>=u)))});let m=null;if(l.length>0&&(l.sort((c,u)=>{const g=c.end-c.start,f=u.end-u.start;return g!==f?g-f:c.start-u.start}),m=l[0]),m){const c=Math.min(s.start,m.start),u=Math.max(s.end,m.end);e.segments.push({id:crypto.randomUUID(),start:c,end:u,readiness:0,lastPracticed:null}),console.log(`Merged
[${c}-${u}] 0`),this.saveToStorage()}}}calculateReadiness(e){const t=this.getPiece(e);if(!t||t.totalMeasures===0)return 0;const r=t.totalMeasures,i=r*r;let s=0;for(let n=1;n<=r;n++){const d=t.segments.filter(o=>o.start<=n&&o.end>=n&&o.readiness===3);if(d.length>0){const o=Math.max(...d.map(l=>l.end-l.start+1));s+=o}else{const o=t.segments.find(l=>l.start===n&&l.end===n);o&&(o.readiness===1?s+=.25:o.readiness===2&&(s+=.5))}}return Math.round(s/i*100)}}const E={audio:{sampleRate:{ideal:44100},channelCount:{ideal:2},echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1},video:!1};function B(){const h="audio/webm; codecs=opus",e="audio/mp4; codecs=mp4a.40.2";let r="";return MediaRecorder.isTypeSupported(h)?r=h:MediaRecorder.isTypeSupported(e)?r=e:(r="audio/webm",MediaRecorder.isTypeSupported(r)||(r="audio/mp4")),{mimeType:r,audioBitsPerSecond:256e3}}class b{constructor(){a(this,"mediaRecorder",null);a(this,"audioChunks",[]);a(this,"currentAudioBlob",null);a(this,"isRecording",!1);a(this,"hasRecording",!1);a(this,"isPlaying",!1);a(this,"audio",null);a(this,"currentAudioUrl",null);a(this,"onRecordingFinished",()=>{});a(this,"onPlaybackFinished",()=>{});a(this,"onError",()=>{})}async startRecording(){try{const e=await navigator.mediaDevices.getUserMedia(E),t=B();this.mediaRecorder=new MediaRecorder(e,t),this.audioChunks=[],this.mediaRecorder.ondataavailable=r=>{r.data.size>0&&this.audioChunks.push(r.data)},this.mediaRecorder.onstop=()=>{this.mediaRecorder&&(this.currentAudioBlob=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType}),this.hasRecording=!0,this.isRecording=!1,e.getTracks().forEach(r=>r.stop()),this.onRecordingFinished())},this.mediaRecorder.start(),this.isRecording=!0}catch(e){this.onError("Failed to start recording: "+e.message)}}stopRecording(){this.mediaRecorder&&this.isRecording&&this.mediaRecorder.stop()}playRecording(){this.currentAudioBlob&&this.hasRecording?(this.currentAudioUrl&&URL.revokeObjectURL(this.currentAudioUrl),this.currentAudioUrl=URL.createObjectURL(this.currentAudioBlob),this.audio=new Audio(this.currentAudioUrl),this.audio.volume=1,this.audio.onended=()=>{this.handlePlaybackEnd()},this.audio.play().catch(e=>this.onError("Playback failed: "+e.message)),this.isPlaying=!0):this.onError("No recording to play")}stopPlaying(){this.audio&&!this.audio.paused&&(this.audio.pause(),this.audio.currentTime=0,this.handlePlaybackEnd())}handlePlaybackEnd(){this.isPlaying=!1,this.currentAudioUrl&&(URL.revokeObjectURL(this.currentAudioUrl),this.currentAudioUrl=null),this.onPlaybackFinished()}}class P{constructor(){a(this,"manager");a(this,"recorder");a(this,"repertoireView");a(this,"practiceView");a(this,"pieceList");a(this,"newPieceForm");a(this,"readinessControls");a(this,"status");a(this,"error");a(this,"recordButton");a(this,"playButton");a(this,"currentPieceId",null);a(this,"practiceQueue",[]);a(this,"currentSegment",null);a(this,"resumeModal");a(this,"resumePieceName");a(this,"resumeBtn");a(this,"discardBtn");a(this,"cancelResumeBtn");this.manager=new R,this.recorder=new b,this.repertoireView=document.getElementById("repertoire-view"),this.practiceView=document.getElementById("practice-view"),this.pieceList=document.getElementById("piece-list"),this.newPieceForm=document.getElementById("new-piece-form"),this.readinessControls=document.getElementById("readiness-controls"),this.status=document.getElementById("status"),this.error=document.getElementById("error"),this.recordButton=document.getElementById("recordButton"),this.playButton=document.getElementById("playButton"),this.resumeModal=document.getElementById("resume-modal"),this.resumePieceName=document.getElementById("resume-piece-name"),this.resumeBtn=document.getElementById("resume-btn"),this.discardBtn=document.getElementById("discard-btn"),this.cancelResumeBtn=document.getElementById("cancel-resume-btn"),this.init()}init(){this.setupRepertoireUI(),this.setupPracticeUI(),this.setupRecorderCallbacks(),this.setupModalCallbacks(),this.renderRepertoire()}setupModalCallbacks(){this.resumeBtn.addEventListener("click",()=>{this.currentPieceId&&(this.resumeSession(this.currentPieceId),this.resumeModal.style.display="none")}),this.discardBtn.addEventListener("click",()=>{this.currentPieceId&&(this.discardAndStartSession(this.currentPieceId),this.resumeModal.style.display="none")}),this.cancelResumeBtn.addEventListener("click",()=>{this.currentPieceId=null,this.resumeModal.style.display="none"})}setupRepertoireUI(){var e,t,r,i,s,n;(e=document.getElementById("add-piece-btn"))==null||e.addEventListener("click",()=>{this.newPieceForm.style.display="block",document.getElementById("add-piece-btn").style.display="none"}),(t=document.getElementById("cancel-piece-btn"))==null||t.addEventListener("click",()=>{this.newPieceForm.style.display="none",document.getElementById("add-piece-btn").style.display="block",document.getElementById("new-piece-name").value="",document.getElementById("new-piece-measures").value=""}),(r=document.getElementById("save-piece-btn"))==null||r.addEventListener("click",()=>{const d=document.getElementById("new-piece-name"),o=document.getElementById("new-piece-measures");d.value&&o.value&&(this.manager.addPiece(d.value,parseInt(o.value)),this.renderRepertoire(),this.newPieceForm.style.display="none",document.getElementById("add-piece-btn").style.display="block",d.value="",o.value="")}),(i=document.getElementById("export-btn"))==null||i.addEventListener("click",()=>{const d=this.manager.exportData(),o=new Blob([d],{type:"application/json"}),l=URL.createObjectURL(o),m=document.createElement("a");m.href=l,m.download=`simple_recorder_backup_${new Date().toISOString().slice(0,10)}.json`,m.click(),URL.revokeObjectURL(l)}),(s=document.getElementById("import-btn"))==null||s.addEventListener("click",()=>{var d;(d=document.getElementById("import-file"))==null||d.click()}),(n=document.getElementById("import-file"))==null||n.addEventListener("change",d=>{var m;const o=(m=d.target.files)==null?void 0:m[0];if(!o)return;const l=new FileReader;l.onload=c=>{var u;(u=c.target)!=null&&u.result&&(this.manager.importData(c.target.result)?(this.renderRepertoire(),alert("Data imported successfully")):alert("Failed to import data"))},l.readAsText(o)})}setupPracticeUI(){var t;(t=document.getElementById("back-to-repertoire"))==null||t.addEventListener("click",()=>{this.suspendSession()}),this.recordButton.addEventListener("click",()=>this.toggleRecording()),this.playButton.addEventListener("click",()=>this.togglePlayback()),document.querySelectorAll(".rate-btn").forEach(r=>{r.addEventListener("click",i=>{const s=parseInt(i.target.getAttribute("data-level")||"0");this.handleReadiness(s)})}),document.addEventListener("keydown",r=>{this.practiceView.style.display!=="none"&&this.resumeModal.style.display!=="flex"&&(r.code==="Space"?(r.preventDefault(),this.playButton.disabled||this.playButton.click()):r.code==="Enter"&&(r.preventDefault(),!this.recordButton.disabled&&this.readinessControls.style.display==="none"&&this.recordButton.click()))})}setupRecorderCallbacks(){this.recorder.onRecordingFinished=()=>{this.updateRecorderUI(),this.readinessControls.style.display="none"},this.recorder.onPlaybackFinished=()=>{this.updateRecorderUI(),this.readinessControls.style.display="block",this.status.textContent="Rate this segment:"},this.recorder.onError=e=>{this.error.textContent=e,this.error.style.display="block",setTimeout(()=>{this.error.style.display="none"},3e3)}}renderRepertoire(){this.pieceList.innerHTML="";const e=this.manager.getPieces();if(e.length===0){this.pieceList.innerHTML='<div style="color:#666; padding:20px;">No pieces yet. Add one to start!</div>';return}e.forEach(t=>{var d;const r=document.createElement("div");r.className="piece-item";const i=this.manager.calculateReadiness(t.id),s=!!this.manager.getSession(t.id),n=s?'<span style="color: #0a84ff; margin-right:8px; font-size:0.8em"><i class="fas fa-pause-circle"></i> Resumable</span>':"";r.innerHTML=`
                <div class="piece-info">
                    <strong>${t.name}</strong><br>
                    <span style="font-size:0.9em; color:#aaa">${t.totalMeasures} measures</span>
					${s?"<br>"+n:""}
                </div>
                <div style="font-weight:bold; color: ${this.getScoreColor(i)}; margin-right: 15px;">
                    ${i}%
                </div>
                <button class="delete-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button>
            `,(d=r.querySelector(".delete-btn"))==null||d.addEventListener("click",o=>{o.stopPropagation(),confirm(`Delete "${t.name}"?`)&&(this.manager.deletePiece(t.id),this.renderRepertoire())}),r.addEventListener("click",()=>{this.startSession(t.id)}),this.pieceList.appendChild(r)})}startSession(e){if(this.currentPieceId=e,this.manager.getSession(e)){const r=this.manager.getPiece(e);r&&(this.resumePieceName.textContent=r.name,this.resumeModal.style.display="flex")}else this.discardAndStartSession(e)}discardAndStartSession(e){this.manager.clearSession(e),this.practiceQueue=this.manager.getPracticeQueue(e),this.activateSessionView(e)}resumeSession(e){const t=this.manager.getSession(e);t?(this.practiceQueue=t,this.manager.clearSession(e),this.activateSessionView(e)):this.discardAndStartSession(e)}activateSessionView(e){const t=this.manager.getPiece(e);t&&(this.repertoireView.style.display="none",this.practiceView.style.display="block",document.getElementById("current-piece-name").textContent=t.name,this.loadNextSegment())}suspendSession(){this.currentPieceId&&this.practiceQueue.length>=0&&(this.currentSegment&&this.practiceQueue.unshift(this.currentSegment),this.practiceQueue.length>0?(this.manager.saveSession(this.currentPieceId,this.practiceQueue),this.recorder.stopPlaying(),this.recorder.stopRecording(),this.stopSession()):this.stopSession())}stopSession(){this.recorder.stopPlaying(),this.recorder.stopRecording(),this.repertoireView.style.display="block",this.practiceView.style.display="none",this.currentPieceId=null,this.currentSegment=null,this.renderRepertoire()}loadNextSegment(){if(this.practiceQueue.length===0){alert("Session complete! Great work."),this.stopSession();return}if(this.currentSegment=this.practiceQueue.shift()||null,this.currentSegment){const e=document.getElementById("current-segment-display");this.currentSegment.start===this.currentSegment.end?e.textContent=`Measure ${this.currentSegment.start}`:e.textContent=`Measures ${this.currentSegment.start} - ${this.currentSegment.end}`,this.readinessControls.style.display="none",this.recorder.hasRecording=!1,this.recorder.audioChunks=[],this.status.textContent="Ready to record",this.updateRecorderUI()}}async toggleRecording(){this.recorder.isRecording?this.recorder.stopRecording():(await this.recorder.startRecording(),this.status.textContent="Recording...",this.updateRecorderUI())}togglePlayback(){this.recorder.isPlaying?this.recorder.stopPlaying():(this.recorder.playRecording(),this.status.textContent="Playing...",this.updateRecorderUI())}handleReadiness(e){this.currentPieceId&&this.currentSegment&&(this.manager.updateSegmentReadiness(this.currentPieceId,this.currentSegment.id,e),this.loadNextSegment())}updateRecorderUI(){const{isRecording:e,isPlaying:t,hasRecording:r}=this.recorder;e?(this.recordButton.classList.add("recording"),this.recordButton.innerHTML='<i class="fas fa-stop"></i><span>Stop</span>',this.playButton.disabled=!0):(this.recordButton.classList.remove("recording"),this.recordButton.innerHTML='<i class="fas fa-microphone"></i><span>Record</span>',this.recordButton.disabled=t),t?this.playButton.innerHTML='<i class="fas fa-stop"></i><span>Stop</span>':(this.playButton.disabled=!r||e,this.playButton.innerHTML='<i class="fas fa-play"></i><span>Play</span>')}getScoreColor(e){return e<25?"#ff453a":e<50?"#ff9f0a":e<75?"#ffd60a":"#30d158"}}document.addEventListener("DOMContentLoaded",()=>{new P});
