var y=Object.defineProperty;var R=(h,e,t)=>e in h?y(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var o=(h,e,t)=>R(h,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class E{constructor(){o(this,"data");o(this,"STORAGE_KEY","simple_recorder_repertoire");this.data=this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem(this.STORAGE_KEY);if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse repertoire data",t)}return{repertoire:[]}}saveToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.data))}exportData(){return JSON.stringify(this.data,null,2)}importData(e){try{const t=JSON.parse(e);if(t&&Array.isArray(t.repertoire))return this.data=t,this.saveToStorage(),!0}catch(t){console.error("Import failed",t)}return!1}getPieces(){return this.data.repertoire}getPiece(e){return this.data.repertoire.find(t=>t.id===e)}addPiece(e,t){const s={id:crypto.randomUUID(),name:e,totalMeasures:t,segments:[]};for(let i=1;i<=t;i++)s.segments.push({id:crypto.randomUUID(),start:i,end:i,readiness:0,lastPracticed:null});return this.data.repertoire.push(s),this.saveToStorage(),s}deletePiece(e){this.data.repertoire=this.data.repertoire.filter(t=>t.id!==e),this.saveToStorage()}getPracticeQueue(e){const t=this.getPiece(e);if(!t)return[];this.processMerges(t);const s=t.segments.filter(n=>n.readiness!==3?!0:!t.segments.some(a=>a.id!==n.id&&a.start<=n.start&&a.end>=n.end&&a.end-a.start>n.end-n.start)),i={0:[],1:[],2:[],3:[]};s.forEach(n=>{const d=Math.max(0,Math.min(3,n.readiness));i[d]||(i[d]=[]),i[d].push(n)});let r=[];for(let n=0;n<=3;n++)r=r.concat(this.shuffleArray(i[n]));return r}shuffleArray(e){const t=[...e];for(let s=t.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[t[s],t[i]]=[t[i],t[s]]}return t}updateSegmentReadiness(e,t,s){const i=this.getPiece(e);if(!i)return;const r=i.segments.find(n=>n.id===t);r&&(r.readiness=s,r.lastPracticed=new Date().toISOString(),this.saveToStorage())}processMerges(e){console.log("--- Process Merges: Current State ---");const t=r=>r.start===r.end?`[${r.start}]`:`[${r.start}-${r.end}]`;[...e.segments].sort((r,n)=>r.start-n.start||r.end-r.start-(n.end-n.start)).forEach(r=>{console.log(`${t(r)} ${r.readiness}`)}),console.log("-------------------------------------");const i=e.segments.filter(r=>r.readiness===3).sort((r,n)=>r.start-n.start);for(const r of i){const n=e.segments.filter(c=>c.end===r.start-1&&c.readiness===3),d=e.segments.filter(c=>c.start===r.end+1&&c.readiness===3),l=[...n,...d].filter(c=>{const u=Math.min(r.start,c.start),g=Math.max(r.end,c.end);return e.segments.some(m=>m.start===u&&m.end===g)?!1:!e.segments.some(m=>!(m.id===r.id||m.id===c.id||m.start>=u&&m.end<=g||m.start<=u&&m.end>=g||!(m.start<=g&&m.end>=u)))});let p=null;if(l.length>0&&(l.sort((c,u)=>{const g=c.end-c.start,f=u.end-u.start;return g!==f?g-f:c.start-u.start}),p=l[0]),p){const c=Math.min(r.start,p.start),u=Math.max(r.end,p.end);e.segments.push({id:crypto.randomUUID(),start:c,end:u,readiness:0,lastPracticed:null}),console.log(`Merged
[${c}-${u}] 0`),this.saveToStorage()}}}calculateReadiness(e){const t=this.getPiece(e);if(!t||t.totalMeasures===0)return 0;const s=t.totalMeasures,i=s*s;let r=0;for(let n=1;n<=s;n++){const d=t.segments.filter(a=>a.start<=n&&a.end>=n&&a.readiness===3);if(d.length>0){const a=Math.max(...d.map(l=>l.end-l.start+1));r+=a}else{const a=t.segments.find(l=>l.start===n&&l.end===n);a&&(a.readiness===1?r+=.25:a.readiness===2&&(r+=.5))}}return Math.round(r/i*100)}}const S={audio:{sampleRate:{ideal:44100},channelCount:{ideal:2},echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1},video:!1};function b(){const h="audio/webm; codecs=opus",e="audio/mp4; codecs=mp4a.40.2";let s="";return MediaRecorder.isTypeSupported(h)?s=h:MediaRecorder.isTypeSupported(e)?s=e:(s="audio/webm",MediaRecorder.isTypeSupported(s)||(s="audio/mp4")),{mimeType:s,audioBitsPerSecond:256e3}}class B{constructor(){o(this,"mediaRecorder",null);o(this,"audioChunks",[]);o(this,"currentAudioBlob",null);o(this,"isRecording",!1);o(this,"hasRecording",!1);o(this,"isPlaying",!1);o(this,"audio",null);o(this,"onRecordingFinished",()=>{});o(this,"onPlaybackFinished",()=>{});o(this,"onError",()=>{})}async startRecording(){try{const e=await navigator.mediaDevices.getUserMedia(S),t=b();this.mediaRecorder=new MediaRecorder(e,t),this.audioChunks=[],this.mediaRecorder.ondataavailable=s=>{s.data.size>0&&this.audioChunks.push(s.data)},this.mediaRecorder.onstop=()=>{this.mediaRecorder&&(this.currentAudioBlob=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType}),this.hasRecording=!0,this.isRecording=!1,e.getTracks().forEach(s=>s.stop()),this.onRecordingFinished())},this.mediaRecorder.start(),this.isRecording=!0}catch(e){this.onError("Failed to start recording: "+e.message)}}stopRecording(){this.mediaRecorder&&this.isRecording&&this.mediaRecorder.stop()}playRecording(){if(this.currentAudioBlob&&this.hasRecording){const e=URL.createObjectURL(this.currentAudioBlob);this.audio=new Audio(e),this.audio.volume=1,this.audio.onended=()=>{this.isPlaying=!1,URL.revokeObjectURL(e),this.onPlaybackFinished()},this.audio.play().catch(t=>this.onError("Playback failed: "+t.message)),this.isPlaying=!0}else this.onError("No recording to play")}stopPlaying(){this.audio&&!this.audio.paused&&(this.audio.pause(),this.audio.currentTime=0,this.isPlaying=!1)}}class P{constructor(){o(this,"manager");o(this,"recorder");o(this,"repertoireView");o(this,"practiceView");o(this,"pieceList");o(this,"newPieceForm");o(this,"readinessControls");o(this,"status");o(this,"error");o(this,"recordButton");o(this,"playButton");o(this,"currentPieceId",null);o(this,"practiceQueue",[]);o(this,"currentSegment",null);this.manager=new E,this.recorder=new B,this.repertoireView=document.getElementById("repertoire-view"),this.practiceView=document.getElementById("practice-view"),this.pieceList=document.getElementById("piece-list"),this.newPieceForm=document.getElementById("new-piece-form"),this.readinessControls=document.getElementById("readiness-controls"),this.status=document.getElementById("status"),this.error=document.getElementById("error"),this.recordButton=document.getElementById("recordButton"),this.playButton=document.getElementById("playButton"),this.init()}init(){this.setupRepertoireUI(),this.setupPracticeUI(),this.setupRecorderCallbacks(),this.renderRepertoire()}setupRepertoireUI(){var e,t,s,i,r,n;(e=document.getElementById("add-piece-btn"))==null||e.addEventListener("click",()=>{this.newPieceForm.style.display="block",document.getElementById("add-piece-btn").style.display="none"}),(t=document.getElementById("cancel-piece-btn"))==null||t.addEventListener("click",()=>{this.newPieceForm.style.display="none",document.getElementById("add-piece-btn").style.display="block",document.getElementById("new-piece-name").value="",document.getElementById("new-piece-measures").value=""}),(s=document.getElementById("save-piece-btn"))==null||s.addEventListener("click",()=>{const d=document.getElementById("new-piece-name"),a=document.getElementById("new-piece-measures");d.value&&a.value&&(this.manager.addPiece(d.value,parseInt(a.value)),this.renderRepertoire(),this.newPieceForm.style.display="none",document.getElementById("add-piece-btn").style.display="block",d.value="",a.value="")}),(i=document.getElementById("export-btn"))==null||i.addEventListener("click",()=>{const d=this.manager.exportData(),a=new Blob([d],{type:"application/json"}),l=URL.createObjectURL(a),p=document.createElement("a");p.href=l,p.download=`simple_recorder_backup_${new Date().toISOString().slice(0,10)}.json`,p.click(),URL.revokeObjectURL(l)}),(r=document.getElementById("import-btn"))==null||r.addEventListener("click",()=>{var d;(d=document.getElementById("import-file"))==null||d.click()}),(n=document.getElementById("import-file"))==null||n.addEventListener("change",d=>{var p;const a=(p=d.target.files)==null?void 0:p[0];if(!a)return;const l=new FileReader;l.onload=c=>{var u;(u=c.target)!=null&&u.result&&(this.manager.importData(c.target.result)?(this.renderRepertoire(),alert("Data imported successfully")):alert("Failed to import data"))},l.readAsText(a)})}setupPracticeUI(){var t;(t=document.getElementById("back-to-repertoire"))==null||t.addEventListener("click",()=>{this.stopSession()}),this.recordButton.addEventListener("click",()=>this.toggleRecording()),this.playButton.addEventListener("click",()=>this.togglePlayback()),document.querySelectorAll(".rate-btn").forEach(s=>{s.addEventListener("click",i=>{const r=parseInt(i.target.getAttribute("data-level")||"0");this.handleReadiness(r)})}),document.addEventListener("keydown",s=>{this.practiceView.style.display!=="none"&&(s.code==="Space"?(s.preventDefault(),this.playButton.disabled||this.playButton.click()):s.code==="Enter"&&(s.preventDefault(),!this.recordButton.disabled&&this.readinessControls.style.display==="none"&&this.recordButton.click()))})}setupRecorderCallbacks(){this.recorder.onRecordingFinished=()=>{this.updateRecorderUI(),this.readinessControls.style.display="none"},this.recorder.onPlaybackFinished=()=>{this.updateRecorderUI(),this.readinessControls.style.display="block",this.status.textContent="Rate this segment:"},this.recorder.onError=e=>{this.error.textContent=e,this.error.style.display="block",setTimeout(()=>{this.error.style.display="none"},3e3)}}renderRepertoire(){this.pieceList.innerHTML="";const e=this.manager.getPieces();if(e.length===0){this.pieceList.innerHTML='<div style="color:#666; padding:20px;">No pieces yet. Add one to start!</div>';return}e.forEach(t=>{var r;const s=document.createElement("div");s.className="piece-item";const i=this.manager.calculateReadiness(t.id);s.innerHTML=`
                <div class="piece-info">
                    <strong>${t.name}</strong><br>
                    <span style="font-size:0.9em; color:#aaa">${t.totalMeasures} measures</span>
                </div>
                <div style="font-weight:bold; color: ${this.getScoreColor(i)}; margin-right: 15px;">
                    ${i}%
                </div>
                <button class="delete-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button>
            `,(r=s.querySelector(".delete-btn"))==null||r.addEventListener("click",n=>{n.stopPropagation(),confirm(`Delete "${t.name}"?`)&&(this.manager.deletePiece(t.id),this.renderRepertoire())}),s.addEventListener("click",()=>{this.startSession(t.id)}),this.pieceList.appendChild(s)})}startSession(e){this.currentPieceId=e;const t=this.manager.getPiece(e);t&&(this.practiceQueue=this.manager.getPracticeQueue(e),this.repertoireView.style.display="none",this.practiceView.style.display="block",document.getElementById("current-piece-name").textContent=t.name,this.loadNextSegment())}stopSession(){this.recorder.stopPlaying(),this.recorder.stopRecording(),this.repertoireView.style.display="block",this.practiceView.style.display="none",this.currentPieceId=null}loadNextSegment(){if(this.practiceQueue.length===0){alert("Session complete! Great work."),this.stopSession();return}if(this.currentSegment=this.practiceQueue.shift()||null,this.currentSegment){const e=document.getElementById("current-segment-display");this.currentSegment.start===this.currentSegment.end?e.textContent=`Measure ${this.currentSegment.start}`:e.textContent=`Measures ${this.currentSegment.start} - ${this.currentSegment.end}`,this.readinessControls.style.display="none",this.recorder.hasRecording=!1,this.recorder.audioChunks=[],this.status.textContent="Ready to record",this.updateRecorderUI()}}toggleRecording(){this.recorder.isRecording?this.recorder.stopRecording():(this.recorder.startRecording(),this.status.textContent="Recording...",this.updateRecorderUI())}togglePlayback(){this.recorder.isPlaying?this.recorder.stopPlaying():(this.recorder.playRecording(),this.status.textContent="Playing...",this.updateRecorderUI())}handleReadiness(e){this.currentPieceId&&this.currentSegment&&(this.manager.updateSegmentReadiness(this.currentPieceId,this.currentSegment.id,e),this.loadNextSegment())}updateRecorderUI(){const{isRecording:e,isPlaying:t,hasRecording:s}=this.recorder;e?(this.recordButton.classList.add("recording"),this.recordButton.innerHTML='<i class="fas fa-stop"></i><span>Stop</span>',this.playButton.disabled=!0):(this.recordButton.classList.remove("recording"),this.recordButton.innerHTML='<i class="fas fa-microphone"></i><span>Record</span>',this.recordButton.disabled=t),t?this.playButton.innerHTML='<i class="fas fa-stop"></i><span>Stop</span>':(this.playButton.disabled=!s||e,this.playButton.innerHTML='<i class="fas fa-play"></i><span>Play</span>')}getScoreColor(e){return e<25?"#ff453a":e<50?"#ff9f0a":e<75?"#ffd60a":"#30d158"}}document.addEventListener("DOMContentLoaded",()=>{new P});
